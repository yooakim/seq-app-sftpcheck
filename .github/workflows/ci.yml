# CI/CD Workflow for Seq.App.SftpCheck
#
# Triggers:
#   - Push to main or dev branches
#   - Pull requests to main or dev branches
#   - Manual workflow dispatch
#
# Jobs:
#   - build: Build, test, and package
#
# Note: Publishing to NuGet and GitHub Releases are handled by release.yml
#       which triggers on version tags (v*)

name: CI/CD

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_suffix: ${{ steps.version.outputs.suffix }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for version calculation

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Calculate version
        id: version
        run: |
          # Read version prefix from Directory.Build.props
          VERSION_PREFIX=$(grep -oP '(?<=<VersionPrefix>)[^<]+' Directory.Build.props)
          echo "Version prefix: $VERSION_PREFIX"

          # Determine version suffix for non-release builds
          VERSION_SUFFIX=""

          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Main branch - no suffix (release candidate)
            VERSION_SUFFIX=""
          else
            # Development build - add branch and build number suffix
            BRANCH_NAME="${{ github.ref_name }}"
            BRANCH_NAME="${BRANCH_NAME//[^a-zA-Z0-9-]/}"  # Sanitize branch name
            BRANCH_NAME="${BRANCH_NAME:0:10}"  # Limit length
            BUILD_NUMBER="${{ github.run_number }}"
            VERSION_SUFFIX="${BRANCH_NAME}-${BUILD_NUMBER}"
          fi

          if [ -n "$VERSION_SUFFIX" ]; then
            FULL_VERSION="${VERSION_PREFIX}-${VERSION_SUFFIX}"
          else
            FULL_VERSION="${VERSION_PREFIX}"
          fi

          echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "version_prefix=$VERSION_PREFIX" >> $GITHUB_OUTPUT
          echo "suffix=$VERSION_SUFFIX" >> $GITHUB_OUTPUT

          echo "Full version: $FULL_VERSION"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build -c Release --no-restore

      - name: Run tests
        run: dotnet test -c Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/TestResults/*.trx
            **/TestResults/**/coverage.cobertura.xml
          retention-days: 7

      - name: Publish application
        run: |
          cd src/Seq.App.SftpCheck
          if [ -n "${{ steps.version.outputs.suffix }}" ]; then
            dotnet publish -c Release -o ./obj/publish --version-suffix "${{ steps.version.outputs.suffix }}"
          else
            dotnet publish -c Release -o ./obj/publish
          fi

      - name: Create NuGet package
        run: |
          cd src/Seq.App.SftpCheck
          if [ -n "${{ steps.version.outputs.suffix }}" ]; then
            dotnet pack -c Release -o ../../artifacts --no-build --version-suffix "${{ steps.version.outputs.suffix }}"
          else
            dotnet pack -c Release -o ../../artifacts --no-build
          fi

      - name: Upload NuGet package artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: artifacts/*.nupkg
          retention-days: 30

      - name: Upload symbols package artifact
        uses: actions/upload-artifact@v4
        with:
          name: symbols-package
          path: artifacts/*.snupkg
          if-no-files-found: ignore
          retention-days: 30
